<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LeadRock Postback Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .slide-down {
            animation: slideDown 0.3s ease-out;
        }
        .pulse-green {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tree view styles */
        .tree-item {
            transition: all 0.2s ease;
        }
        .tree-children {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .toggle-icon {
            transition: transform 0.2s ease;
        }
        .toggle-icon.rotated {
            transform: rotate(90deg);
        }
        .campaign-row {
            background-color: #f8fafc;
            border-left: 4px solid #3b82f6;
        }
        .adset-row {
            background-color: #f1f5f9;
            border-left: 4px solid #6366f1;
            margin-left: 20px;
        }
        .ad-row {
            background-color: #ffffff;
            border-left: 4px solid #10b981;
            margin-left: 40px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Container principal -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üìä Dashboard LeadRock</h1>
            <p class="text-gray-600">Visualiza√ß√£o hier√°rquica de campanhas, conjuntos e an√∫ncios</p>
        </div>

        <!-- Alerta de novo postback -->
        <div id="alert" class="hidden mb-6 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg slide-down">
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="font-semibold">Novo postback recebido!</span>
            </div>
        </div>

        <!-- Estat√≠sticas Gerais -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-gray-600 text-sm font-medium mb-1">Total de Campanhas</div>
                <div class="text-2xl font-bold text-blue-600" id="totalCampaigns">0</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-gray-600 text-sm font-medium mb-1">Total de Leads</div>
                <div class="text-2xl font-bold text-green-600" id="totalLeads">0</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-gray-600 text-sm font-medium mb-1">Convers√µes</div>
                <div class="text-2xl font-bold text-purple-600" id="totalConversions">0</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-gray-600 text-sm font-medium mb-1">Valor Total</div>
                <div class="text-2xl font-bold text-green-600" id="totalPayout">$0.00</div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Buscar Campanha/Conjunto/An√∫ncio</label>
                    <input type="text" id="searchInput" placeholder="Digite para buscar..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-2">
                    <button id="expandAll" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
                        Expandir Tudo
                    </button>
                    <button id="collapseAll" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">
                        Recolher Tudo
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabela Hier√°rquica -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">Vis√£o Hier√°rquica por Campanha</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campanha / Conjunto / An√∫ncio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Leads</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Convers√µes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Taxa</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="hierarchicalTable" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <div class="loading-spinner"></div>
                                    <p class="mt-2">Carregando dados hier√°rquicos...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tabela de Convers√µes Detalhadas -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">Convers√µes Detalhadas</h2>
                <button id="toggleDetails" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
                    Mostrar Detalhes
                </button>
            </div>
            <div id="detailsSection" class="hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campanha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conjunto</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">An√∫ncio</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora</th>
                            </tr>
                        </thead>
                        <tbody id="conversionsTable" class="bg-white divide-y divide-gray-200">
                            <!-- Ser√° preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 text-center text-gray-500 text-sm">
            <p>Atualiza√ß√£o autom√°tica a cada 10 segundos</p>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let allConversions = [];
        let hierarchicalData = {};
        let expandedItems = new Set();

        // Fun√ß√£o para formatar valor monet√°rio
        function formatCurrencyUSD(value) {
            if (!value || value === 0) return '$0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Fun√ß√£o para calcular taxa de convers√£o
        function calculateConversionRate(leads, conversions) {
            if (!leads || leads === 0) return '0%';
            const rate = (conversions / leads) * 100;
            return rate.toFixed(1) + '%';
        }

        // Fun√ß√£o para obter badge de status
        function getStatusBadge(status) {
            const badges = {
                'FTD': 'bg-green-100 text-green-800',
                'DEPOSIT': 'bg-blue-100 text-blue-800',
                'PENDING': 'bg-yellow-100 text-yellow-800',
                'REJECTED': 'bg-red-100 text-red-800',
                'TRASH': 'bg-gray-100 text-gray-800',
                'CANCEL': 'bg-red-100 text-red-800'
            };
            const color = badges[status] || 'bg-gray-100 text-gray-800';
            return `<span class="px-2 py-1 rounded-full text-xs font-semibold ${color}">${status || 'N/A'}</span>`;
        }

        // Fun√ß√£o para processar dados hier√°rquicos
        function processHierarchicalData(conversions) {
            const hierarchy = {};
            let totalLeads = 0;
            let totalConversions = 0;
            let totalPayout = 0;

            conversions.forEach(conversion => {
                const campanha = conversion.campanha || conversion.sub_id3 || 'N/A';
                const conjunto = conversion.conjunto || conversion.sub_id4 || 'N/A';
                const anuncio = conversion.anuncio || conversion.sub_id5 || 'N/A';
                const status = conversion.status || 'UNKNOWN';
                const payout = parseFloat(conversion.payout) || 0;
                const isConversion = ['FTD', 'DEPOSIT', 'APPROVED'].includes(status);
                const isLead = !['TRASH', 'CANCEL', 'REJECTED'].includes(status);

                // Inicializar campanha se n√£o existir
                if (!hierarchy[campanha]) {
                    hierarchy[campanha] = {
                        leads: 0,
                        conversions: 0,
                        payout: 0,
                        adsets: {}
                    };
                }

                // Inicializar conjunto se n√£o existir
                if (!hierarchy[campanha].adsets[conjunto]) {
                    hierarchy[campanha].adsets[conjunto] = {
                        leads: 0,
                        conversions: 0,
                        payout: 0,
                        ads: {}
                    };
                }

                // Inicializar an√∫ncio se n√£o existir
                if (!hierarchy[campanha].adsets[conjunto].ads[anuncio]) {
                    hierarchy[campanha].adsets[conjunto].ads[anuncio] = {
                        leads: 0,
                        conversions: 0,
                        payout: 0,
                        status: status
                    };
                }

                // Atualizar contagens
                if (isLead) {
                    hierarchy[campanha].leads++;
                    hierarchy[campanha].adsets[conjunto].leads++;
                    hierarchy[campanha].adsets[conjunto].ads[anuncio].leads++;
                    totalLeads++;
                }

                if (isConversion) {
                    hierarchy[campanha].conversions++;
                    hierarchy[campanha].adsets[conjunto].conversions++;
                    hierarchy[campanha].adsets[conjunto].ads[anuncio].conversions++;
                    totalConversions++;
                }

                hierarchy[campanha].payout += payout;
                hierarchy[campanha].adsets[conjunto].payout += payout;
                hierarchy[campanha].adsets[conjunto].ads[anuncio].payout += payout;
                totalPayout += payout;
            });

            return {
                hierarchy,
                totals: {
                    campaigns: Object.keys(hierarchy).length,
                    leads: totalLeads,
                    conversions: totalConversions,
                    payout: totalPayout
                }
            };
        }

        // Fun√ß√£o para renderizar tabela hier√°rquica
        function renderHierarchicalTable(data) {
            const tbody = document.getElementById('hierarchicalTable');
            const { hierarchy, totals } = data;

            // Atualizar estat√≠sticas gerais
            document.getElementById('totalCampaigns').textContent = totals.campaigns;
            document.getElementById('totalLeads').textContent = totals.leads.toLocaleString('pt-BR');
            document.getElementById('totalConversions').textContent = totals.conversions.toLocaleString('pt-BR');
            document.getElementById('totalPayout').textContent = formatCurrencyUSD(totals.payout);

            if (Object.keys(hierarchy).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            Nenhuma campanha encontrada
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            
            Object.keys(hierarchy).forEach(campaignName => {
                const campaign = hierarchy[campaignName];
                const campaignId = `campaign-${campaignName.replace(/\s+/g, '-')}`;
                const isExpanded = expandedItems.has(campaignId);

                // Linha da campanha
                html += `
                    <tr class="campaign-row tree-item">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            <div class="flex items-center cursor-pointer" onclick="toggleItem('${campaignId}')">
                                <svg class="toggle-icon w-4 h-4 mr-2 ${isExpanded ? 'rotated' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                                <span class="font-semibold">${campaignName}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${campaign.leads}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${campaign.conversions}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${campaign.leads > 0 ? (campaign.conversions / campaign.leads * 100 >= 10 ? 'text-green-600' : 'text-yellow-600') : 'text-gray-600'}">
                            ${calculateConversionRate(campaign.leads, campaign.conversions)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${formatCurrencyUSD(campaign.payout)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">CAMPAIGN</span>
                        </td>
                    </tr>
                `;

                // Conjuntos (adsets) - s√≥ mostra se expandido
                if (isExpanded) {
                    Object.keys(campaign.adsets).forEach(adsetName => {
                        const adset = campaign.adsets[adsetName];
                        const adsetId = `${campaignId}-adset-${adsetName.replace(/\s+/g, '-')}`;
                        const isAdsetExpanded = expandedItems.has(adsetId);

                        html += `
                            <tr class="adset-row tree-item">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700">
                                    <div class="flex items-center cursor-pointer ml-4" onclick="toggleItem('${adsetId}')">
                                        <svg class="toggle-icon w-4 h-4 mr-2 ${isAdsetExpanded ? 'rotated' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                        <span>${adsetName}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${adset.leads}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${adset.conversions}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${adset.leads > 0 ? (adset.conversions / adset.leads * 100 >= 10 ? 'text-green-600' : 'text-yellow-600') : 'text-gray-600'}">
                                    ${calculateConversionRate(adset.leads, adset.conversions)}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${formatCurrencyUSD(adset.payout)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-800">ADSET</span>
                                </td>
                            </tr>
                        `;

                        // An√∫ncios - s√≥ mostra se expandido
                        if (isAdsetExpanded) {
                            Object.keys(adset.ads).forEach(adName => {
                                const ad = adset.ads[adName];

                                html += `
                                    <tr class="ad-row tree-item">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 ml-8">
                                            ${adName}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${ad.leads}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${ad.conversions}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${ad.leads > 0 ? (ad.conversions / ad.leads * 100 >= 10 ? 'text-green-600' : 'text-yellow-600') : 'text-gray-600'}">
                                            ${calculateConversionRate(ad.leads, ad.conversions)}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${formatCurrencyUSD(ad.payout)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            ${getStatusBadge(ad.status)}
                                        </td>
                                    </tr>
                                `;
                            });
                        }
                    });
                }
            });

            tbody.innerHTML = html;
        }

        // Fun√ß√£o para alternar expans√£o de itens
        function toggleItem(itemId) {
            if (expandedItems.has(itemId)) {
                expandedItems.delete(itemId);
            } else {
                expandedItems.add(itemId);
            }
            renderHierarchicalTable(hierarchicalData);
        }

        // Fun√ß√£o para expandir/recolher tudo
        function expandAll() {
            const { hierarchy } = hierarchicalData;
            Object.keys(hierarchy).forEach(campaignName => {
                const campaignId = `campaign-${campaignName.replace(/\s+/g, '-')}`;
                expandedItems.add(campaignId);
                
                Object.keys(hierarchy[campaignName].adsets).forEach(adsetName => {
                    const adsetId = `${campaignId}-adset-${adsetName.replace(/\s+/g, '-')}`;
                    expandedItems.add(adsetId);
                });
            });
            renderHierarchicalTable(hierarchicalData);
        }

        function collapseAll() {
            expandedItems.clear();
            renderHierarchicalTable(hierarchicalData);
        }

        // Fun√ß√£o para carregar convers√µes
        async function loadConversions() {
            try {
                const response = await fetch('/api/conversions');
                allConversions = await response.json();
                
                // Processar dados hier√°rquicos
                hierarchicalData = processHierarchicalData(allConversions);
                
                // Renderizar tabela hier√°rquica
                renderHierarchicalTable(hierarchicalData);
                
                // Renderizar tabela detalhada
                renderDetailedTable(allConversions);

            } catch (error) {
                console.error('Erro ao carregar convers√µes:', error);
            }
        }

        // Fun√ß√£o para renderizar tabela detalhada
        function renderDetailedTable(conversions) {
            const tbody = document.getElementById('conversionsTable');
            
            if (conversions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            Nenhuma convers√£o encontrada
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = conversions.map(conversion => {
                const campanha = conversion.campanha || conversion.sub_id3 || 'N/A';
                const conjunto = conversion.conjunto || conversion.sub_id4 || 'N/A';
                const anuncio = conversion.anuncio || conversion.sub_id5 || 'N/A';
                const status = conversion.status || 'N/A';
                const payout = conversion.payout || 0;
                const date = conversion.date || conversion.created_at;

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${campanha}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${conjunto}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${anuncio}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${getStatusBadge(status)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${formatCurrencyUSD(payout)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(date).toLocaleDateString('pt-BR')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(date).toLocaleTimeString('pt-BR')}</td>
                    </tr>
                `;
            }).join('');
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            loadConversions();
            
            // Event listeners
            document.getElementById('expandAll').addEventListener('click', expandAll);
            document.getElementById('collapseAll').addEventListener('click', collapseAll);
            document.getElementById('toggleDetails').addEventListener('click', function() {
                const detailsSection = document.getElementById('detailsSection');
                const isHidden = detailsSection.classList.contains('hidden');
                
                if (isHidden) {
                    detailsSection.classList.remove('hidden');
                    this.textContent = 'Ocultar Detalhes';
                } else {
                    detailsSection.classList.add('hidden');
                    this.textContent = 'Mostrar Detalhes';
                }
            });

            // Busca em tempo real
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                // Implementar filtro de busca se necess√°rio
            });

            // Atualizar a cada 10 segundos
            setInterval(loadConversions, 10000);
        });
    </script>
</body>
</html>
